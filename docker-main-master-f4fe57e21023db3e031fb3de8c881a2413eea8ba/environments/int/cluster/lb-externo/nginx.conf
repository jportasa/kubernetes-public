#########################################################################                                                                                                                                    
#                                                                                                                                                                                                            
# CONFIG PARA LB NGINX EXTERNO PARA REENVIAR A KUBERNETES o V3                                                                                                                                                 
#                                                                                                                                                                                                            
# Ajustar las variables $MY_COMPUTER_IP y $MINIKUBE_IP a las de tu PC                                                                                                                                        
# Ajustar fichero de hosts:  int.wtransnet.com y app-int.wtransnet.com para que apunten eth de tu PC                                                                                                         
# Dejar en /c/docker/volumes/ los ficheros estaticos necesarios                                                                                                                                              
# Copiar los ficheros de certificado (.crt, key) en el mismo path donde est√° nginx.conf                                                                                                                      
# Cuidado!!! cerrar skype porque escucha en el puerto 443                                                                                                                                                    
#                                                                                                                                                                                                            
# Provar para validar por ej:                                                                                                                                                                                
# https://int.wtransnet.com/wtn-tracking-web/images/logo-wtransnet.png                                                                                                                                       
# https://app-int.wtransnet.com/auth/private/actuator/health                                                                                                                                                 
#                                                                                                                                                                                                            
#########################################################################                                                                                                                                    
                                                                                                                                                                                                             
upstream int-k8s-cluster {                                                                                                                                                                                   
   server 192.168.43.190:30080;                                                                                                                                                                              
   server 192.168.43.191:30080;                                                                                                                                                                              
}                                                                                                                                                                                                            
                                                                                                                                                                                                             
upstream int-web-v3-cluster {                                                                                                                                                                                
   server webint01:80;                                                                                                                                                                                       
   server webint02:80;                                                                                                                                                                                       
}                                                                                                                                                                                                            
                                                                                                                                                                                                             
server {                                                                                                                                                                                                     
    listen       443 ssl;                                                                                                                                                                                    
    server_name int.wtransnet.com;                                                                                                                                                                           
                                                                                                                                                                                                             
    ssl on;                                                                                                                                                                                                  
    ssl_certificate  /etc/ssl/vs4/appmobilewtn.crt;                                                                                                                                                          
    ssl_certificate_key  /etc/ssl/vs4/appmobilewtn.key;                                                                                                                                                      
                                                                                                                                                                                                             
    location / {                                                                                                                                                                                             
         proxy_pass  http://int-web-v3-cluster;                                                                                                                                                              
    }                                                                                                                                                                                                        
    location ~ ^/(data|logoest|comprofile|bolsas|alm|startpage|qapmark)/ {                                                                                                                                   
         proxy_pass  http://int-k8s-cluster;                                                                                                                                                                 
    }                                                                                                                                                                                                        
    location ~ ^/(wtn-adm-web|wtn-tracking-web|wtn-doc-drive)/ {                                                                                                                                             
         proxy_pass  http://int-k8s-cluster;                                                                                                                                                                 
    }                                                                                                                                                                                                        
                                                                                                                                                                                                             
    # Configuracion para enviar al apache las ips del cliente                                                                                                                                                
    proxy_set_header        Host            $host;                                                                                                                                                           
    proxy_set_header        X-Real-IP       $remote_addr;                                                                                                                                                    
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;                                                                                                                                      
                                                                                                                                                                                                             
    access_log  /var/log/nginx/int.wtransnet.com.access.log;                                                                                                                                                 
    error_log  /var/log/nginx/int.wtransnet.com.error.log;                                                                                                                                                   
                                                                                                                                                                                                             
}                                                                                                                                                                                                            
                                                                                                                                                                                                             
server {                                                                                                                                                                                                     
    listen       443 ssl;                                                                                                                                                                                    
    server_name app-int.wtransnet.com;                                                                                                                                                                       
                                                                                                                                                                                                             
    ssl on;                                                                                                                                                                                                  
    ssl_certificate  /etc/ssl/vs4/appmobilewtn.crt;                                                                                                                                                          
    ssl_certificate_key  /etc/ssl/vs4/appmobilewtn.key;                                                                                                                                                      
                                                                                                                                                                                                             
    location / {                                                                                                                                                                                             
         proxy_pass http://int-web-v3-cluster;                                                                                                                                                               
    }                                                                                                                                                                                                        
    location ~ ^/(audit|auth|bridge-wtn3|credit|email|file-upload|geo-searcher|integration|remote-log|sms|tracking)/ {                                                                                       
         proxy_pass http://int-k8s-cluster;                                                                                                                                                                  
    }                                                                                                                                                                                                        
                                                                                                                                                                                                             
    # Configuracion para enviar al apache las ips del cliente                                                                                                                                                
    proxy_set_header        Host            $host;                                                                                                                                                           
    proxy_set_header        X-Real-IP       $remote_addr;                                                                                                                                                    
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;                                                                                                                                      
                                                                                                                                                                                                             
    access_log  /var/log/nginx/app-int.wtransnet.com.access.log;                                                                                                                                             
    error_log  /var/log/nginx/app-int.wtransnet.com.error.log;                                                                                                                                               
}                                                                                                                                                                                                            